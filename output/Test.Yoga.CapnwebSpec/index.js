// Generated by purs version 0.15.15
import * as $foreign from "./foreign.js";
import * as Control_Bind from "../Control.Bind/index.js";
import * as Control_Promise from "../Control.Promise/index.js";
import * as Data_Eq from "../Data.Eq/index.js";
import * as Data_Identity from "../Data.Identity/index.js";
import * as Data_Show from "../Data.Show/index.js";
import * as Effect_Aff from "../Effect.Aff/index.js";
import * as Effect_Class from "../Effect.Class/index.js";
import * as Test_Spec from "../Test.Spec/index.js";
import * as Test_Spec_Assertions from "../Test.Spec.Assertions/index.js";
import * as Yoga_Capnweb from "../Yoga.Capnweb/index.js";
var describe = /* #__PURE__ */ Test_Spec.describe(Data_Identity.monadIdentity);
var discard = /* #__PURE__ */ Control_Bind.discard(Control_Bind.discardUnit);
var discard1 = /* #__PURE__ */ discard(/* #__PURE__ */ Test_Spec.bindSpecT(Data_Identity.bindIdentity));
var it = /* #__PURE__ */ Test_Spec.it(Data_Identity.monadIdentity)(Test_Spec.exampleMUnit);
var bind = /* #__PURE__ */ Control_Bind.bind(Effect_Aff.bindAff);
var liftEffect = /* #__PURE__ */ Effect_Class.liftEffect(Effect_Aff.monadEffectAff);
var discard2 = /* #__PURE__ */ discard(Effect_Aff.bindAff);
var shouldEqual = /* #__PURE__ */ Test_Spec_Assertions.shouldEqual(Effect_Aff.monadThrowAff);
var shouldEqual1 = /* #__PURE__ */ shouldEqual(Data_Show.showString)(Data_Eq.eqString);
var shouldEqual2 = /* #__PURE__ */ shouldEqual(Data_Show.showInt)(Data_Eq.eqInt);
var spec = /* #__PURE__ */ describe("Yoga.Capnweb")(/* #__PURE__ */ discard1(/* #__PURE__ */ describe("basic RPC")(/* #__PURE__ */ discard1(/* #__PURE__ */ it("call1 round-trips a value")(/* #__PURE__ */ bind(/* #__PURE__ */ liftEffect($foreign.mkTestTarget))(function (target) {
    return bind(liftEffect(Yoga_Capnweb.connectPair(target)))(function (conn) {
        return bind(Yoga_Capnweb.call1(conn)("ping")("hello"))(function (v) {
            return discard2(shouldEqual1(v)("pong: hello"))(function () {
                return liftEffect(Yoga_Capnweb.dispose(conn));
            });
        });
    });
})))(function () {
    return it("call2 passes two arguments")(bind(liftEffect($foreign.mkTestTarget))(function (target) {
        return bind(liftEffect(Yoga_Capnweb.connectPair(target)))(function (conn) {
            return bind(Yoga_Capnweb.call2(conn)("add")(3)(4))(function (v) {
                return discard2(shouldEqual2(v)(7))(function () {
                    return liftEffect(Yoga_Capnweb.dispose(conn));
                });
            });
        });
    }));
})))(function () {
    return describe("stub lifecycle")(discard1(it("disposing a returned stub decreases imports")(bind(liftEffect($foreign.mkTestTarget))(function (target) {
        return bind(liftEffect(Yoga_Capnweb.connectPair(target)))(function (conn) {
            return bind(liftEffect(Yoga_Capnweb.getStats(conn)))(function (before) {
                return bind(Yoga_Capnweb.call1(conn)("makeCounter")(10))(function (stub) {
                    return bind(liftEffect(Yoga_Capnweb.getStats(conn)))(function (afterCreate) {
                        return discard2(shouldEqual2(afterCreate.imports)(before.imports + 1 | 0))(function () {
                            return discard2(liftEffect(Yoga_Capnweb.disposeStub(stub)))(function () {
                                return discard2(Control_Promise.toAff($foreign.delayMs(50)))(function () {
                                    return bind(liftEffect(Yoga_Capnweb.getStats(conn)))(function (afterDispose) {
                                        return discard2(shouldEqual2(afterDispose.imports)(before.imports))(function () {
                                            return liftEffect(Yoga_Capnweb.dispose(conn));
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    })))(function () {
        return it("undisposed stubs leak")(bind(liftEffect($foreign.mkTestTarget))(function (target) {
            return bind(liftEffect(Yoga_Capnweb.connectPair(target)))(function (conn) {
                return bind(liftEffect(Yoga_Capnweb.getStats(conn)))(function (before) {
                    return bind(Yoga_Capnweb.call1(conn)("makeCounter")(1))(function () {
                        return bind(Yoga_Capnweb.call1(conn)("makeCounter")(2))(function () {
                            return bind(Yoga_Capnweb.call1(conn)("makeCounter")(3))(function () {
                                return discard2(Control_Promise.toAff($foreign.delayMs(50)))(function () {
                                    return bind(liftEffect(Yoga_Capnweb.getStats(conn)))(function (after) {
                                        return discard2(shouldEqual2(after.imports)(before.imports + 3 | 0))(function () {
                                            return liftEffect(Yoga_Capnweb.dispose(conn));
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        }));
    }));
}));
export {
    mkTestTarget,
    delayMs
} from "./foreign.js";
export {
    spec
};
//# sourceMappingURL=index.js.map
